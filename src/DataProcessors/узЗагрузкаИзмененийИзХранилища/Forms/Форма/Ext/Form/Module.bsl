
&НаКлиенте
Процедура КомандаЗагрузитьИзмененияИзХранилища(Команда)
	Если НЕ ПроверитьЗаполнение() Тогда
		Возврат;
	Конецесли;
	Если НЕ ПолучатьИзмененияИзХранилища(Объект.Конфигурация) Тогда
		Сообщить("Ошибка! в конфигурации не настроена загрузка изменений из хранилища");
	Конецесли;
	РезультатФункции = ЗагрузитьИзмененияИзХранилищаНаСервере();
	РезультатФункции.ТабДокОтчет.Показать("Загруженная история хранилища");
КонецПроцедуры

&НаСервере
Функция ПолучатьИзмененияИзХранилища(пКонфигурация) 
	Возврат пКонфигурация.ПолучатьИзмененияИзХранилища;
КонецФункции 

&НаКлиенте
Функция ВыгрузитьИзмененияНаКлиенте()
	ИмяФайлаДляВыгрузки = ПолучитьФайлВыгрузкиИзмененийНаСервере();
	ФайлВыгрузкиИзменений = КаталогВременныхФайлов() + ИмяФайлаДляВыгрузки;	
	
	НастройкиЗапускаКонфигуратора = ПолучитьНастройкиЗапускаКонфигуратораНаСервере(ФайлВыгрузкиИзменений);
	ТекстКоманды = НастройкиЗапускаКонфигуратора.ТекстКоманды;
	
	//Из за того, что на сервере команда выгрузки хранилища не работает, поэтому приходится вызывать на клиенте
	WshShell= Новый COMОбъект("WScript.Shell");
	WshShell.Run(ТекстКоманды, 0, 1);		
	
	АдресФайлаПолученныйНаКлиенте = "";
	Если НЕ ПоместитьФайл(АдресФайлаПолученныйНаКлиенте, ФайлВыгрузкиИзменений,ИмяФайлаДляВыгрузки,Ложь) Тогда
		Сообщить("Ошибка! Не удалось поместить файл на сервер");
		Возврат Неопределено;
	КонецЕсли;
	
	РезультатФункции = ЗагрузитьИзмененияИзХранилищаНаСервере(АдресФайлаПолученныйНаКлиенте);
	Возврат РезультатФункции;
КонецФункции

&НаСервере
Функция ПолучитьФайлВыгрузкиИзмененийНаСервере()
	пОбъект = РеквизитФормыВЗначение("Объект"); 
	Возврат пОбъект.ПолучитьИмяФайлаДляВыгрузки();
КонецФункции 

&НаСервере
Функция ПолучитьНастройкиЗапускаКонфигуратораНаСервере(ФайлВыгрузкиИзменений) 
	пОбъект = РеквизитФормыВЗначение("Объект"); 
	НастройкиЗапускаКонфигуратора = пОбъект.ПолучитьНастройкиЗапускаКонфигуратора(ФайлВыгрузкиИзменений);	
	
	Возврат НастройкиЗапускаКонфигуратора;
КонецФункции 

&НаСервере
Функция ЗагрузитьИзмененияИзХранилищаНаСервере(АдресФайла = Неопределено)
	пОбъект = РеквизитФормыВЗначение("Объект"); 
	РезультатФункции = пОбъект.ЗагрузитьИзмененияИзХранилища(АдресФайла);
	Возврат РезультатФункции;
КонецФункции


&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Если Параметры.Свойство("Конфигурация") Тогда
		Объект.Конфигурация = Параметры.Конфигурация;
	Конецесли;
	Объект.ВерсияС = ПолучитьПоследнююЗагруженнуюВерсиюНаСервере();
КонецПроцедуры

&НаСервере
Функция ПолучитьПоследнююЗагруженнуюВерсиюНаСервере()
	Возврат Справочники.узИсторияХранилища.ПолучитьПоследнююЗагруженнуюВерсию(Объект.Конфигурация);
КонецФункции 


&НаКлиенте
Процедура КонфигурацияПриИзменении(Элемент)
	Объект.ВерсияС = ПолучитьПоследнююЗагруженнуюВерсиюНаСервере();
КонецПроцедуры

